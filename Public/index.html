
<!doctype html>
<html>
<head>
  <title>LokalQueue</title>
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <style type="text/css">
    #login, #loggedin {
      display: none;
    }
    .text-overflow {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      width: 500px;
    }
  </style>
</head>

<body>
<div class="container">
  <div id="login">
    <h1>Please Login with Spotify</h1>
    <a href="/login" class="btn btn-primary">Log in with Spotify</a>
  </div>
  <div id="loggedin">
    <div id="user-profile">
    </div>
    <div id="oauth">
    </div>
  </div>
  <div id="playlist">
    <h1>Player</h1>
    <dl>
      <dt>
        <button id="starten-song">Start</button>
        <button id="play">Play</button>
        <button id="pause">Pause</button>
        <button id="next">Next</button>
        <button id="previous">Previous</button>
      </dt>
    </dl>
    <table id="queue">
    </table>

  </div>
</div>

<script>
  let songslength = 0;
  let inter = setInterval(fetchSongs, 5000);

function fetchSongs(){
  let songs = loadSongs();
}
const loadSongs = () =>{
  const  xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function(){
    if(this.readyState==4 && this.status == 200 ){
      const  songs = JSON.parse(xhttp.responseText);
      if(songs.length>songslength) {
        songslength = songs.length;
        let par = document.getElementById("queue").querySelectorAll(".songs");
        if(par !== null && par.length > 0)
          par.forEach(n => n.remove());
        for(let song in songs) {
          let row = document.createElement("tr");
          let d1 = document.createElement("td");
          let d2 = document.createElement("td");
          let d3 = document.createElement("td");
          let bt = document.createElement("button");
          bt.innerText = "Delete";
          d1.appendChild(bt);
          d2.innerText = "Song: "+ songs[song].id;
          d3.innerText = ",Rating:  "+ songs[song].rating;
          row.classList.add("songs");
          row.id = songs[song].id;
          row.appendChild(d1);
          row.appendChild(d2);
          row.appendChild(d3);
          bt.addEventListener('click',function () {
            $.ajax({
              url:'http://localhost:8888/songs/'+songs[song].id,
              method: 'delete'
            });
            songslength = songs.length -1;
            document.getElementById(songs[song].id).remove();
          });
          document.getElementById("queue").appendChild(row);
        }
      }
    }
  };
  xhttp.open("GET","http://localhost:8888/songs",true);
  xhttp.send();

};
</script>

<script id="user-profile-template" type="text/x-handlebars-template">
  <h1>Logged in as {{display_name}}</h1>
  <div class="media">
    <h2>User ID: {{id}} </h2>
  </div>
</script>

<script id="oauth-template" type="text/x-handlebars-template">
  <h2>oAuth info</h2>
  <dl class="dl-horizontal">
    <dt>Access token</dt><dd class="text-overflow" id="lol">{{access_token}}</dd>
    <dt>Refresh token</dt><dd class="text-overflow">{{refresh_token}}</dd>
  </dl>
</script>


<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
<script src="https://sdk.scdn.co/spotify-player.js" defer></script>
<script>
  window.onSpotifyWebPlaybackSDKReady = () => {
    console.log("The Web Playback SDK is ready. We have access to Spotify.Player");
    const token = document.getElementById("lol").innerText;
    const player = new window.Spotify.Player({
      name: 'Web Playback SDK Quick Start Player',
      getOAuthToken: cb => { cb(token)}
    });
    console.log(player);
    player.addListener('initialization_error', ({ message }) => { console.error(message); });
    player.addListener('authentication_error', ({ message }) => { console.error(message); });
    player.addListener('account_error', ({ message }) => { console.error(message); });
    player.addListener('playback_error', ({ message }) => { console.error(message); });
    player.addListener('player_state_changed', state => { console.log(state); });
    player.addListener('ready', ({ device_id }) => {
      console.log('Ready with Device ID', device_id);
    });
    player.addListener('not_ready', ({ device_id }) => {
      console.log('Device ID has gone offline', device_id);
    });
    player.addListener('ready',({device_id})=>{
      $.post("/did",{did:device_id});
      console.log("sent");
    });

    player.connect();
    document.getElementById('starten-song').addEventListener('click',function () {
      $.ajax({
        url:'/start'
      });
      console.log("Click");
    },false);
    document.getElementById('pause').addEventListener('click',function () {
      player.pause().then(()=>{console.log("Paused")});

    });
    document.getElementById('play').addEventListener('click',function () {
      player.resume().then(()=>{console.log("Resume!!")});
    });
    document.getElementById('next').addEventListener('click',function () {
      player.nextTrack().then(() => {console.log('Skipped to next track!')});
    });
    document.getElementById('previous').addEventListener('click',function () {
      player.previousTrack().then(() => {console.log('Set to previous track!')});
    });
  };
</script>

<script>


  (function() {

    /**
     * Obtains parameters from the hash of the URL
     * @return Object
     */
    function getHashParams() {
      var hashParams = {};
      var e, r = /([^&;=]+)=?([^&;]*)/g,
              q = window.location.hash.substring(1);
      while ( e = r.exec(q)) {
        hashParams[e[1]] = decodeURIComponent(e[2]);
      }
      return hashParams;
    }
    $.ajax({
      type: 'POST',
      cache: false,
      contentType: 'application/json',
      dataType: "json",
      success: function (result) {
        console.log(result);
      }
    });
    var userProfileSource = document.getElementById('user-profile-template').innerHTML,
            userProfileTemplate = Handlebars.compile(userProfileSource),
            userProfilePlaceholder = document.getElementById('user-profile');

    var oauthSource = document.getElementById('oauth-template').innerHTML,
            oauthTemplate = Handlebars.compile(oauthSource),
            oauthPlaceholder = document.getElementById('oauth');

    var params = getHashParams();

    var access_token = params.access_token,
            refresh_token = params.refresh_token,
            error = params.error;

    if (error) {
      alert('There was an error during the authentication');
    } else {
      if (access_token) {
        oauthPlaceholder.innerHTML = oauthTemplate({
          access_token: access_token,
          refresh_token: refresh_token
        });

        $.ajax({
          url: 'https://api.spotify.com/v1/me',
          headers: {
            'Authorization': 'Bearer ' + access_token
          },
          success: function(response) {
            userProfilePlaceholder.innerHTML = userProfileTemplate(response);

            $('#login').hide();
            $('#loggedin').show();
          }
        });
      } else {

        $('#login').show();
        $('#loggedin').hide();
      }

      document.getElementById('obtain-new-token').addEventListener('click', function() {
        $.ajax({
          url: '/refresh_token',
          data: {
            'refresh_token': refresh_token
          }
        }).done(function(data) {
          access_token = data.access_token;
          oauthPlaceholder.innerHTML = oauthTemplate({
            access_token: access_token,
            refresh_token: refresh_token
          });
        });
      }, false);


    }
  })();

  // loadSongs();


</script>
</body>
</html>



